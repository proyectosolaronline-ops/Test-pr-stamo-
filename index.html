<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Solicitar Pr√©stamo</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
:root{--bg:#080b10;--surf:#0f1319;--card:#141a24;--card2:#19202e;--b1:#1c2535;--b2:#243047;--acc:#00e5b0;--acc2:#00b88d;--blue:#3b82f6;--gold:#f59e0b;--red:#f43f5e;--txt:#dce8f5;--mut:#4d617d;--soft:#7a92b0;--r:14px;--rs:9px}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--txt);min-height:100dvh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(ellipse 70% 50% at 90% 5%,rgba(0,229,176,.08) 0%,transparent 60%),radial-gradient(ellipse 50% 60% at 5% 95%,rgba(59,130,246,.06) 0%,transparent 60%)}
.wrap{position:relative;z-index:1;max-width:430px;margin:0 auto;padding:0 16px 120px}
.hdr{display:flex;align-items:center;justify-content:space-between;padding:22px 0 6px}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.28rem;letter-spacing:-.03em}
.logo em{color:var(--acc);font-style:normal}
.back-btn{display:flex;align-items:center;gap:6px;font-size:.78rem;color:var(--soft);background:none;border:none;cursor:pointer;transition:color .2s;padding:6px 0}
.back-btn:hover{color:var(--acc)}
.sdot{width:8px;height:8px;border-radius:50%;background:var(--mut);transition:background .4s}
.sdot.ok{background:var(--acc)}.sdot.off{background:var(--gold)}.sdot.busy{background:var(--blue);animation:blink .9s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.resumen{background:var(--card);border:1px solid var(--b1);border-radius:var(--r);padding:18px 20px;margin:12px 0 22px;position:relative;overflow:hidden}
.resumen::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--acc),var(--blue))}
.res-title{font-size:.62rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--mut);margin-bottom:14px;font-family:'Syne',sans-serif}
.res-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.res-item .lbl{font-size:.65rem;color:var(--mut);text-transform:uppercase;letter-spacing:.07em;margin-bottom:3px}
.res-item .val{font-family:'Syne',sans-serif;font-size:1.05rem;font-weight:700;color:var(--txt)}
.res-item .val.acc{color:var(--acc)}.res-item .val.gold{color:var(--gold)}
.res-total{margin-top:14px;padding-top:14px;border-top:1px solid var(--b1);display:flex;justify-content:space-between;align-items:center}
.res-total .lbl{font-size:.75rem;color:var(--soft);font-weight:500}
.res-total .val{font-family:'Syne',sans-serif;font-size:1.55rem;font-weight:800;color:var(--acc);letter-spacing:-.03em}
.no-calc{text-align:center;padding:14px 0;font-size:.83rem;color:var(--mut);line-height:1.7}
.slabel{font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--mut);margin:22px 0 10px}
.slabel span{color:var(--red)}
.fcard{background:var(--card);border:1px solid var(--b1);border-radius:var(--r);padding:20px;margin-bottom:16px}
.field{margin-bottom:18px}.field:last-child{margin-bottom:0}
.field label{display:flex;align-items:center;gap:6px;font-size:.78rem;font-weight:500;color:var(--soft);margin-bottom:7px}
.field label .req{color:var(--red);font-size:.9em}
.inp{width:100%;background:var(--surf);border:1.5px solid var(--b2);border-radius:var(--rs);color:var(--txt);font-family:'DM Sans',sans-serif;font-size:.92rem;padding:11px 14px;transition:border-color .15s,box-shadow .15s;outline:none;-webkit-appearance:none}
.inp::placeholder{color:var(--mut)}
.inp:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(0,229,176,.1)}
.inp.error{border-color:var(--red);box-shadow:0 0 0 3px rgba(244,63,94,.1)}
.inp.ok{border-color:var(--acc2)}
.field-hint{font-size:.72rem;color:var(--mut);margin-top:5px;min-height:1em;transition:color .2s}
.field-hint.err{color:var(--red)}.field-hint.ok{color:var(--acc2)}.field-hint.info{color:#7eb8ff}
.progress-bar{height:3px;background:var(--b2);border-radius:99px;margin-bottom:20px;overflow:hidden;display:none}
.progress-bar.show{display:block}
.progress-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--acc),var(--blue));width:0%;transition:width .4s ease}
.fab-wrap{position:fixed;bottom:20px;left:0;right:0;max-width:430px;margin:0 auto;padding:0 16px;z-index:100}
.fab{width:100%;display:flex;align-items:center;justify-content:center;gap:10px;padding:16px 20px;background:#25D366;border:none;border-radius:99px;color:#fff;font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 32px rgba(37,211,102,.35),0 2px 8px rgba(0,0,0,.4);transition:transform .15s,box-shadow .15s,background .15s;position:relative;overflow:hidden}
.fab::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.12) 0%,transparent 60%);border-radius:inherit}
.fab:hover:not(:disabled){background:#128C7E;transform:translateY(-2px)}
.fab:active{transform:scale(.97)}
.fab:disabled{background:var(--b2);box-shadow:none;cursor:not-allowed;color:var(--mut)}
.fab-loading{width:20px;height:20px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;display:none}
.fab.sending .fab-loading{display:block}.fab.sending .fab-icon{display:none}.fab.sending .fab-txt{opacity:.7}
@keyframes spin{to{transform:rotate(360deg)}}
#toast{position:fixed;bottom:86px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--card2);border:1px solid var(--b2);padding:9px 18px;border-radius:99px;font-size:.8rem;color:var(--txt);box-shadow:0 8px 24px rgba(0,0,0,.5);transition:transform .3s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;z-index:200;pointer-events:none;max-width:calc(100vw - 32px)}
#toast.show{transform:translateX(-50%) translateY(0)}
#toast.ok{border-color:rgba(0,229,176,.3);color:var(--acc)}
#toast.err{border-color:rgba(244,63,94,.3);color:#ff6b8a}
@media(max-width:360px){.res-grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="wrap">
  <div class="hdr">
    <span class="logo">Sim<em>Pr√©stamo</em></span>
    <button class="back-btn" onclick="window.history.back()">‚Üê Regresar</button>
  </div>

  <!-- Barra de progreso -->
  <div class="progress-bar" id="progressBar">
    <div class="progress-fill" id="progressFill"></div>
  </div>

  <!-- Resumen de simulaci√≥n -->
  <div class="resumen" id="resumenBox">
    <div class="res-title">Resumen de tu simulaci√≥n</div>
    <div id="resumenContenido" class="no-calc">
      Carga la app y realiza una simulaci√≥n para ver el resumen aqu√≠.
    </div>
  </div>

  <!-- Formulario de datos personales -->
  <p class="slabel">Tus datos <span>*</span></p>
  <div class="fcard">
    <div class="field">
      <label>Nombre completo <span class="req">*</span></label>
      <input class="inp" type="text" id="nombre" placeholder="Ej. Juan P√©rez L√≥pez" autocomplete="name">
      <div class="field-hint" id="hint-nombre"></div>
    </div>
    <div class="field">
      <label>Tel√©fono <span class="req">*</span></label>
      <input class="inp" type="tel" id="telefono" placeholder="10 d√≠gitos" maxlength="10" autocomplete="tel">
      <div class="field-hint" id="hint-telefono"></div>
    </div>
    <div class="field">
      <label>Correo electr√≥nico <span class="req">*</span></label>
      <input class="inp" type="email" id="correo" placeholder="correo@ejemplo.com" autocomplete="email">
      <div class="field-hint" id="hint-correo"></div>
    </div>
  </div>

  <p class="slabel">Notas adicionales</p>
  <div class="fcard">
    <div class="field">
      <label>Comentarios u observaciones</label>
      <input class="inp" type="text" id="nota" placeholder="Opcional">
    </div>
  </div>
</div>

<!-- Bot√≥n flotante WhatsApp -->
<div class="fab-wrap">
  <button class="fab" id="fab" onclick="enviar()">
    <span class="fab-icon">üì±</span>
    <div class="fab-loading"></div>
    <span class="fab-txt">Enviar solicitud por WhatsApp</span>
  </button>
</div>

<!-- Toast de notificaciones -->
<div id="toast"></div>

<script>
// ============================================
// CONFIGURACI√ìN ‚Äî CAMBIA ESTA URL
// ============================================
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyaeqN6Dq0JQh4eMtlQQwtnBEy5HdCrJ3HZd6_2RXjx9WPMafj57ajN5SVzBuxnn-OJqQ/exec';
const ADMIN_FALLBACK  = '524425839311'; // n√∫mero WhatsApp fallback

// ============================================
// VARIABLES GLOBALES
// ============================================
let adminPhone = ADMIN_FALLBACK;
let calcData   = null;   // { capital, dias, ip, it, tp, pd }
let fotoINE    = null;   // base64 string
let fotoCDom   = null;   // base64 string
let ubicacion  = null;   // { lat, lng, dir }
let enviando   = false;

// ============================================
// UTILIDADES
// ============================================
const gi = id => document.getElementById(id);

function toast(msg, type = '') {
  const t = gi('toast');
  t.textContent = msg;
  t.className   = 'show ' + type;
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.className = '', 3000);
}

function setProgress(pct) {
  const bar  = gi('progressBar');
  const fill = gi('progressFill');
  if (pct <= 0) {
    bar.classList.remove('show');
    fill.style.width = '0%';
  } else {
    bar.classList.add('show');
    fill.style.width = pct + '%';
    if (pct >= 100) setTimeout(() => setProgress(0), 800);
  }
}

// ============================================
// VALIDACIONES
// ============================================
function validarNombre(v) {
  if (!v || v.trim().length < 3) return 'Ingresa tu nombre completo';
  if (!/^[a-z√°√©√≠√≥√∫√º√±A-Z√Å√â√ç√ì√ö√ú√ë\s'-]+$/i.test(v)) return 'Solo letras y espacios';
  return '';
}

function validarTelefono(v) {
  if (!v) return 'Ingresa tu tel√©fono';
  if (!/^\d{10}$/.test(v)) return 'Debe tener exactamente 10 d√≠gitos';
  return '';
}

function validarCorreo(v) {
  if (!v) return 'Ingresa tu correo';
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) return 'Correo inv√°lido';
  return '';
}

function mostrarError(fieldId, msg) {
  const inp  = gi(fieldId);
  const hint = gi('hint-' + fieldId);
  if (inp)  { inp.classList.add('error'); inp.classList.remove('ok'); }
  if (hint) { hint.textContent = msg; hint.className = 'field-hint err'; }
}

function limpiarError(fieldId) {
  const inp  = gi(fieldId);
  const hint = gi('hint-' + fieldId);
  if (inp)  { inp.classList.remove('error'); inp.classList.add('ok'); }
  if (hint) { hint.textContent = ''; hint.className = 'field-hint ok'; }
}

// ============================================
// CONSTRUIR MENSAJE WHATSAPP (fallback local)
// Se usa solo si el script no devuelve la URL
// ============================================
function construirMensajeLocal(nombre, telefono) {
  const fmt = n => '$' + Number(n||0).toLocaleString('es-MX', {minimumFractionDigits:2});

  let msg = `üè¶ *NUEVA SOLICITUD DE PR√âSTAMO*\n\n`;
  msg += `üë§ *Nombre:* ${nombre}\n`;
  msg += `üìû *Tel√©fono:* ${telefono}\n`;
  const correo = gi('correo').value.trim();
  if (correo) msg += `üìß *Correo:* ${correo}\n`;

  if (calcData) {
    msg += `\nüí∞ *SIMULACI√ìN*\n`;
    msg += `‚Ä¢ Capital: ${fmt(calcData.capital)}\n`;
    msg += `‚Ä¢ Plazo: ${calcData.dias} d√≠as\n`;
    msg += `‚Ä¢ Inter√©s: ${calcData.ip}%\n`;
    msg += `‚Ä¢ Total: ${fmt(calcData.tp)}\n`;
    msg += `‚Ä¢ Pago diario: ${fmt(calcData.pd)}\n`;
  }

  if (ubicacion) {
    msg += `\nüìç https://www.google.com/maps?q=${ubicacion.lat},${ubicacion.lng}\n`;
  }

  const nota = gi('nota').value.trim();
  if (nota) msg += `\nüìù ${nota}\n`;

  msg += `\nüìÖ ${new Date().toLocaleString('es-MX')}`;
  msg += `\nüì≤ _Registrado desde formulario web_`;
  return msg;
}

// ============================================
// POST AL APPS SCRIPT
// ============================================
async function postScript(payload) {
  const resp = await fetch(APPS_SCRIPT_URL, {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body:    JSON.stringify(payload)
  });

  if (!resp.ok) {
    const err = await resp.text().catch(() => '(sin detalles)');
    throw new Error(`HTTP ${resp.status} - ${err}`);
  }

  return resp.json();
}

// ============================================
// REGISTRAR EN GOOGLE SHEETS
// Env√≠a todos los datos al Apps Script:
//  - Simulaci√≥n ‚Üí pesta√±a Simulaciones
//  - Cliente    ‚Üí pesta√±a Clientes (busca/crea)
//  - Retorna    ‚Üí whatsappUrl lista para abrir
// ============================================
async function registrarEnScript(nombre, telefono) {
  const correo = gi('correo').value.trim();
  const nota   = gi('nota').value.trim();

  const payload = {
    // Datos del cliente
    nombre,
    telefono,
    correo,
    // Datos de la simulaci√≥n
    capital:     calcData?.capital   ?? '',
    dias:        calcData?.dias      ?? '',
    interesPct:  calcData?.ip        ?? '',   // Apps Script normaliza ‚Üí interesPorc
    interesM:    calcData?.it        ?? '',   // Apps Script normaliza ‚Üí interesTotal
    total:       calcData?.tp        ?? '',   // Apps Script normaliza ‚Üí totalPrestar
    pagoDiario:  calcData?.pd        ?? '',
    // Ubicaci√≥n
    latitud:     ubicacion?.lat      ?? '',
    longitud:    ubicacion?.lng      ?? '',
    direccion:   ubicacion?.dir      ?? '',
    // Fotos (base64)
    fotoINE:     fotoINE             ?? '',
    fotoComprobante: fotoCDom        ?? '',
    // Extras
    notas:       nota,
    fecha:       new Date().toLocaleString('es-MX'),
    estado:      'Nuevo'
  };

  setProgress(40);
  toast('Guardando en base de datos...', '');

  const res = await postScript(payload);

  if (res.success !== true) {
    throw new Error(res.message || 'El script rechaz√≥ la solicitud');
  }

  toast('‚úÖ Guardado correctamente', 'ok');
  return res.data; // { id, idCliente, row, estado, whatsappUrl }
}

// ============================================
// FUNCI√ìN PRINCIPAL ‚Äî ENVIAR
// Flujo: validar ‚Üí registrar en Sheet ‚Üí abrir WhatsApp
// ============================================
async function enviar() {
  if (enviando) return;

  const nombre   = gi('nombre').value.trim();
  const telefono = gi('telefono').value.trim();
  const correo   = gi('correo').value.trim();

  // Validar campos
  const errNombre   = validarNombre(nombre);
  const errTelefono = validarTelefono(telefono);
  const errCorreo   = validarCorreo(correo);

  if (errNombre)   { mostrarError('nombre',   errNombre);   return; } else limpiarError('nombre');
  if (errTelefono) { mostrarError('telefono', errTelefono); return; } else limpiarError('telefono');
  if (errCorreo)   { mostrarError('correo',   errCorreo);   return; } else limpiarError('correo');

  if (!calcData) {
    toast('Primero realiza una simulaci√≥n', 'err');
    return;
  }

  enviando = true;
  const fab = gi('fab');
  fab.classList.add('sending');
  fab.disabled = true;

  try {
    setProgress(20);

    // ‚îÄ‚îÄ 1. Registrar en Google Sheets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let scriptData = null;
    try {
      scriptData = await registrarEnScript(nombre, telefono);
    } catch(errScript) {
      console.error('Error registrando en script:', errScript);
      toast('‚ö†Ô∏è No se pudo guardar, continuando con WhatsApp...', 'err');
      // No bloqueamos el flujo ‚Äî abrimos WhatsApp igual con mensaje local
    }

    setProgress(70);

    // ‚îÄ‚îÄ 2. Determinar URL de WhatsApp ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Si el script guard√≥ OK y devolvi√≥ la URL, la usamos
    // Si no, construimos el mensaje localmente como fallback
    let waUrl;
    if (scriptData && scriptData.whatsappUrl) {
      waUrl = scriptData.whatsappUrl;         // ‚Üê URL generada por el Apps Script
    } else {
      const msg = construirMensajeLocal(nombre, telefono);
      waUrl = `https://wa.me/${adminPhone}?text=${encodeURIComponent(msg)}`;
    }

    setProgress(90);
    toast('Abriendo WhatsApp...', 'ok');
    await new Promise(r => setTimeout(r, 600));

    // ‚îÄ‚îÄ 3. Abrir WhatsApp ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.open(waUrl, '_blank');

    setProgress(100);

    const idMsg = scriptData?.id
      ? `\nID: ${scriptData.id}`
      : '';
    toast(`¬°Solicitud enviada!${idMsg}`, 'ok');

    // Limpiar formulario despu√©s de 3 s
    setTimeout(() => {
      gi('nombre').value   = '';
      gi('telefono').value = '';
      gi('correo').value   = '';
      gi('nota').value     = '';
      ['nombre','telefono','correo'].forEach(f => {
        const el = gi(f);
        if (el) { el.classList.remove('ok','error'); }
        const h = gi('hint-'+f);
        if (h) h.textContent = '';
      });
      setProgress(0);
    }, 3000);

  } catch(e) {
    console.error('Error en enviar():', e);
    toast('Error: ' + e.message, 'err');
    setProgress(0);
  } finally {
    enviando = false;
    fab.classList.remove('sending');
    fab.disabled = false;
  }
}

// ============================================
// CARGAR TEL√âFONO ADMIN DESDE SHEET
// ============================================
async function cargarAdminPhone() {
  try {
    const res  = await fetch(`${APPS_SCRIPT_URL}?tipo=admin`);
    const json = await res.json();
    if (json.success && json.data?.activo) {
      // El tel√©fono activo viene en TelefonoAdmin sheet
      const res2  = await fetch(`${APPS_SCRIPT_URL}?tipo=parametros`);
      // Si hay endpoint espec√≠fico, usarlo; de lo contrario usar fallback
    }
  } catch(e) {
    console.warn('No se pudo cargar adminPhone, usando fallback');
  }
}

// ============================================
// RENDERIZAR RESUMEN DE SIMULACI√ìN
// Llama esta funci√≥n desde tu l√≥gica de simulaci√≥n
// pasando los datos calculados
// ============================================
function renderResumen(data) {
  // data = { capital, dias, ip (inter√©s%), it (inter√©s$), tp (total), pd (pago diario) }
  calcData = data;
  const fmt = n => '$' + Number(n||0).toLocaleString('es-MX', {minimumFractionDigits:2, maximumFractionDigits:2});

  gi('resumenContenido').innerHTML = `
    <div class="res-grid">
      <div class="res-item">
        <div class="lbl">Capital</div>
        <div class="val acc">${fmt(data.capital)}</div>
      </div>
      <div class="res-item">
        <div class="lbl">Plazo</div>
        <div class="val">${data.dias} d√≠as</div>
      </div>
      <div class="res-item">
        <div class="lbl">Inter√©s</div>
        <div class="val gold">${data.ip}%</div>
      </div>
      <div class="res-item">
        <div class="lbl">Inter√©s $</div>
        <div class="val gold">${fmt(data.it)}</div>
      </div>
    </div>
    <div class="res-total">
      <span class="lbl">Total a recibir</span>
      <span class="val">${fmt(data.tp)}</span>
    </div>
    <div class="res-total" style="margin-top:8px">
      <span class="lbl">Pago diario</span>
      <span class="val">${fmt(data.pd)}</span>
    </div>
  `;
}

// ============================================
// VALIDACI√ìN EN TIEMPO REAL
// ============================================
['nombre','telefono','correo'].forEach(id => {
  const el = gi(id);
  if (!el) return;
  el.addEventListener('blur', () => {
    const val = el.value.trim();
    let err = '';
    if (id === 'nombre')   err = validarNombre(val);
    if (id === 'telefono') err = validarTelefono(val);
    if (id === 'correo')   err = validarCorreo(val);
    if (err) mostrarError(id, err);
    else     limpiarError(id);
  });
  el.addEventListener('input', () => {
    if (el.classList.contains('error')) {
      const val = el.value.trim();
      let err = '';
      if (id === 'nombre')   err = validarNombre(val);
      if (id === 'telefono') err = validarTelefono(val);
      if (id === 'correo')   err = validarCorreo(val);
      if (!err) limpiarError(id);
    }
  });
  // Solo n√∫meros en tel√©fono
  if (id === 'telefono') {
    el.addEventListener('keypress', e => {
      if (!/[0-9]/.test(e.key)) e.preventDefault();
    });
  }
});

// ============================================
// INICIALIZACI√ìN
// ============================================
document.addEventListener('DOMContentLoaded', () => {
  cargarAdminPhone();

  // EJEMPLO ‚Äî descomenta para probar el resumen
  // renderResumen({ capital: 5000, dias: 27, ip: 21.5, it: 1075, tp: 6075, pd: 225 });
});
</script>
</body>
</html>
